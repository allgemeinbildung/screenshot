<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Screenshot einreichen</title>
    <style>
        /* General Body & Root Container */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: transparent;
            margin: 0;
            padding: 10px;
            box-sizing: border-box;
            height: 200px;
        }
        .container { 
            background-color: white; 
            padding: 15px; 
            border-radius: 8px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
            width: 100%; 
            height: 100%;
            display: flex;
            gap: 15px;
            box-sizing: border-box;
            align-items: stretch;
        }

        /* Column Base Styles */
        .column {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        /* Left Column: All Controls */
        .left-column { flex: 1 1 50%; gap: 8px; }
        .left-column h2 { margin: 0; color: #1c1e21; font-size: 0.9rem; font-weight: 600; }
        .left-column .info-text { font-size: 0.8rem; margin: 0; line-height: 1.3; color: #4b4f56; }
        .left-column label { display: block; margin-bottom: 2px; font-weight: 600; color: #4b4f56; font-size: 0.75rem; }
        .left-column input[type="text"] { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccd0d5; border-radius: 6px; font-size: 0.8rem; }
        .left-column button { background-color: #1877f2; color: white; width: 100%; padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: bold; }
        .left-column button:disabled { background-color: #a0a0a0; }
        .left-column #status { font-weight: bold; font-size: 0.75rem; min-height: 1.3em; line-height: 1.3; text-align: center; }

        /* Middle Column: Separator */
        .middle-column { flex: 0 0 1px; background-color: #e0e0e0; }
        
        /* Right Column: Paste & Preview Area */
        #paste-area { 
            flex: 1 1 50%;
            border: 2px dashed #1877f2;
            border-radius: 8px; 
            cursor: pointer;
            position: relative;
            background-color: #f7faff;
            overflow: hidden; /* Hide parts of the lens that go outside */
        }
        #paste-area p { margin: 0; padding: 10px; color: #0d3d82; font-size: 0.9rem; font-weight: 500; text-align: center; }
        #paste-area.has-image { border-style: solid; border-color: #4CAF50; background-color: #f0f0f0; cursor: crosshair; }
        #paste-area.has-image p { display: none; }
        #preview { 
            display: none;
            width: 100%; height: 100%;
            object-fit: contain;
        }

        /* --- Zoom/Loupe Styles --- */
        #zoom-result {
            display: none;
            position: absolute;
            top: -17px; /* Align with top of container */
            left: -232px; /* Position it to the left of the paste-area */
            width: 200px;
            height: 200px;
            border: 2px solid #1877f2;
            border-radius: 50%; /* Circular result pane */
            background-repeat: no-repeat;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 100;
            pointer-events: none;
        }
        /* NEW: The visible lens on the image */
        #zoom-lens {
            display: none;
            position: absolute;
            width: 80px;  /* Size of the lens */
            height: 80px;
            border: 2px solid #1877f2;
            pointer-events: none; /* Lets mouse events pass through to the image */
            z-index: 99;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="column left-column">
            <div>
                <h2 id="assignment-title"></h2>
                <p id="question-text" class="info-text"></p>
            </div>
            <div>
                 <label for="studentName">Dein Identifikationscode:</label>
                 <input type="text" id="studentName" required>
            </div>
            <button id="submitButton" disabled>Einreichen</button>
            <div id="status"></div>
        </div>

        <div class="column middle-column"></div>

        <div class="column right-column" id="paste-area">
             <div id="zoom-result"></div>
             <div id="zoom-lens"></div> <p>Screenshot hier einfügen<br>(Ctrl+V)</p>
            <img id="preview" alt="Screenshot Vorschau"/>
        </div>
    </div>

    <script>
        // --- Elements ---
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx6f6zabGntalDkp4N9gQcD2XZHKK05pa3Ppmgz6Z09sMEMq6lm2SkRCd4O3RSu3FXCpw/exec'; 
        const studentNameInput = document.getElementById('studentName');
        const pasteArea = document.getElementById('paste-area');
        const previewImage = document.getElementById('preview');
        const submitButton = document.getElementById('submitButton');
        const statusDiv = document.getElementById('status');
        const titleElement = document.getElementById('assignment-title');
        const questionElement = document.getElementById('question-text');
        const zoomResult = document.getElementById('zoom-result');
        const zoomLens = document.getElementById('zoom-lens'); // New lens element
        
        let imageDataUrl = null;
        let eventListenersAttached = false; // Flag to manage listeners

        // --- URL Params & Initial Setup ---
        const urlParams = new URLSearchParams(window.location.search);
        const assignmentIdParam = urlParams.get('assignmentId') || 'Screenshot Abgabe';
        const subIdsParam = urlParams.get('subIds') || 'Abgabe Punktzahl';
        const question1Param = urlParams.get('question1') || 'Gib links deinen Code ein und füge rechts den Screenshot ein. Bewege die Maus über das Bild, um es zu vergrößern.';
        
        titleElement.textContent = subIdsParam;
        questionElement.innerHTML = question1Param;
        
        // --- Core Functions ---
        window.addEventListener('paste', handlePaste);
        submitButton.addEventListener('click', handleSubmit);
        studentNameInput.addEventListener('input', checkFormState);

        function handlePaste(event) {
            const items = (event.clipboardData || window.clipboardData).items;
            let imageFile = null;
            for (const item of items) { if (item.type.indexOf('image') !== -1) { imageFile = item.getAsFile(); break; } }
            if (imageFile) {
                event.preventDefault();
                statusDiv.textContent = 'Bild erkannt!'; statusDiv.style.color = 'green';
                const reader = new FileReader();
                reader.onloadend = () => { 
                    imageDataUrl = reader.result; 
                    previewImage.src = imageDataUrl; 
                    previewImage.style.display = 'block';
                    pasteArea.classList.add('has-image');
                    checkFormState();
                    initializeZoom(imageDataUrl); 
                };
                reader.readAsDataURL(imageFile);
            }
        }
        
        // Unchanged from previous version
        function checkFormState() { submitButton.disabled = !(studentNameInput.value.trim() && imageDataUrl); }
        function handleSubmit() {
            if (!studentNameInput.value.trim() || !imageDataUrl) return;
            submitButton.disabled = true; statusDiv.textContent = 'Wird übermittelt...'; statusDiv.style.color = 'black';
            const payload = { studentName: studentNameInput.value.trim(), imageData: imageDataUrl, assignmentId: assignmentIdParam, subIds: subIdsParam, question1: question1Param };
            fetch(SCRIPT_URL, { method: 'POST', mode: 'cors', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(payload) })
            .then(res => res.json())
            .then(result => {
                if (result.status === 'success') {
                    if (result.score && result.score.includes('/')) {
                        statusDiv.style.color = 'green';
                        statusDiv.innerHTML = `Erfolgreich! Punktzahl: <strong>${result.score}</strong>`;
                    } else {
                        statusDiv.style.color = '#D83B01';
                        statusDiv.innerHTML = `Übermittelt, aber Punktzahl nicht erkannt. Bitte erneut versuchen.`;
                    }
                    resetForm();
                } else { throw new Error(result.message); }
            })
            .catch(err => {
                statusDiv.textContent = `Fehler: ${err.message}`; 
                statusDiv.style.color = 'red'; 
                submitButton.disabled = false; 
            });
        }
        
        function resetForm() {
            setTimeout(() => {
                studentNameInput.value = '';
                previewImage.src = '';
                previewImage.style.display = 'none';
                pasteArea.classList.remove('has-image');
                imageDataUrl = null;
                submitButton.disabled = true; 
                statusDiv.textContent = '';
                destroyZoom();
            }, 8000);
        }

        // --- ZOOM FUNCTIONALITY ---
        let ratioX, ratioY;

        function initializeZoom(imageUrl) {
            if (eventListenersAttached) return; // Don't attach listeners multiple times

            const originalImage = new Image();
            originalImage.onload = function() {
                ratioX = this.width / previewImage.clientWidth;
                ratioY = this.height / previewImage.clientHeight;
                
                zoomResult.style.backgroundImage = `url('${imageUrl}')`;
                zoomResult.style.backgroundSize = `${this.width}px ${this.height}px`;

                pasteArea.addEventListener('mousemove', moveLens);
                pasteArea.addEventListener('mouseenter', showZoom);
                pasteArea.addEventListener('mouseleave', hideZoom);
                eventListenersAttached = true;
            };
            originalImage.src = imageUrl;
        }

        const showZoom = () => {
            zoomResult.style.display = 'block';
            zoomLens.style.display = 'block';
        };

        const hideZoom = () => {
            zoomResult.style.display = 'none';
            zoomLens.style.display = 'none';
        };

        function moveLens(e) {
            e.preventDefault();
            const rect = previewImage.getBoundingClientRect();
            let x = e.clientX - rect.left;
            let y = e.clientY - rect.top;

            // Position the LENS element
            let lensX = x - (zoomLens.offsetWidth / 2);
            let lensY = y - (zoomLens.offsetHeight / 2);
            
            // Boundary checks for the LENS
            if (lensX < 0) lensX = 0;
            if (lensY < 0) lensY = 0;
            if (lensX > previewImage.clientWidth - zoomLens.offsetWidth) lensX = previewImage.clientWidth - zoomLens.offsetWidth;
            if (lensY > previewImage.clientHeight - zoomLens.offsetHeight) lensY = previewImage.clientHeight - zoomLens.offsetHeight;

            zoomLens.style.left = lensX + 'px';
            zoomLens.style.top = lensY + 'px';

            // Calculate background position for the RESULT pane
            let bgPosX = -(x * ratioX - zoomResult.clientWidth / 2);
            let bgPosY = -(y * ratioY - zoomResult.clientHeight / 2);
            
            zoomResult.style.backgroundPosition = `${bgPosX}px ${bgPosY}px`;
        }

        function destroyZoom() {
            if (!eventListenersAttached) return;
            pasteArea.removeEventListener('mousemove', moveLens);
            pasteArea.removeEventListener('mouseenter', showZoom);
            pasteArea.removeEventListener('mouseleave', hideZoom);
            hideZoom();
            eventListenersAttached = false;
        }
    </script>
</body>
</html>
