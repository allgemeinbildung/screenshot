<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Screenshot einreichen</title>
    <style>
        /* CSS is unchanged from the previous version */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: transparent;
            margin: 0;
            padding: 10px;
            box-sizing: border-box;
            height: 200px;
        }
        .container { 
            background-color: white; 
            padding: 15px; 
            border-radius: 8px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
            width: 100%; 
            height: 100%;
            display: flex;
            gap: 15px;
            box-sizing: border-box;
            align-items: stretch;
        }
        .column {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .left-column { flex: 1 1 50%; gap: 8px; }
        .left-column h2 { margin: 0; color: #1c1e21; font-size: 0.9rem; font-weight: 600; }
        .left-column .info-text { font-size: 0.8rem; margin: 0; line-height: 1.3; color: #4b4f56; }
        .left-column label { display: block; margin-bottom: 2px; font-weight: 600; color: #4b4f56; font-size: 0.75rem; }
        .left-column input[type="text"] { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccd0d5; border-radius: 6px; font-size: 0.8rem; }
        .left-column button { background-color: #1877f2; color: white; width: 100%; padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: bold; }
        .left-column button:disabled { background-color: #a0a0a0; }
        .left-column #status { font-weight: bold; font-size: 0.75rem; min-height: 1.3em; line-height: 1.3; text-align: center; }
        .middle-column { flex: 0 0 1px; background-color: #e0e0e0; }
        #paste-area { 
            flex: 1 1 50%;
            border: 2px dashed #1877f2;
            border-radius: 8px; 
            cursor: pointer;
            position: relative;
            background-color: #f7faff;
            overflow: hidden;
        }
        #paste-area p { margin: 0; padding: 10px; color: #0d3d82; font-size: 0.9rem; font-weight: 500; text-align: center; }
        #paste-area.has-image { border-style: solid; border-color: #4CAF50; background-color: #f0f0f0; cursor: crosshair; }
        #paste-area.has-image p { display: none; }
        #preview { 
            display: none;
            width: 100%; height: 100%;
            object-fit: contain;
        }
        #zoom-result {
            display: none;
            position: absolute;
            top: -17px;
            left: -232px;
            width: 200px;
            height: 200px;
            border: 2px solid #1877f2;
            border-radius: 50%;
            background-repeat: no-repeat;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 100;
            pointer-events: none;
        }
        #zoom-lens {
            display: none;
            position: absolute;
            width: 80px;
            height: 80px;
            border: 2px solid #1877f2;
            pointer-events: none;
            z-index: 99;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="column left-column">
            <div>
                <h2 id="assignment-title"></h2>
                <p id="question-text" class="info-text"></p>
            </div>
            <div>
                 <label for="studentName">Dein Identifikationscode:</label>
                 <input type="text" id="studentName" required>
            </div>
            <button id="submitButton" disabled>Einreichen</button>
            <div id="status"></div>
        </div>
        <div class="column middle-column"></div>
        <div class="column right-column" id="paste-area">
             <div id="zoom-result"></div>
             <div id="zoom-lens"></div>
            <p>Screenshot hier einfügen<br>(Ctrl+V)</p>
            <img id="preview" alt="Screenshot Vorschau"/>
        </div>
    </div>

    <script>
        // --- Elements and State ---
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx6f6zabGntalDkp4N9gQcD2XZHKK05pa3Ppmgz6Z09sMEMq6lm2SkRCd4O3RSu3FXCpw/exec'; 
        const studentNameInput = document.getElementById('studentName');
        const pasteArea = document.getElementById('paste-area');
        const previewImage = document.getElementById('preview');
        const submitButton = document.getElementById('submitButton');
        const statusDiv = document.getElementById('status');
        const titleElement = document.getElementById('assignment-title');
        const questionElement = document.getElementById('question-text');
        const zoomResult = document.getElementById('zoom-result');
        const zoomLens = document.getElementById('zoom-lens');
        
        let imageDataUrl = null;
        let eventListenersAttached = false;

        // --- URL Params & Initial Setup ---
        const urlParams = new URLSearchParams(window.location.search);
        const assignmentIdParam = urlParams.get('assignmentId') || 'Screenshot Abgabe';
        const subIdsParam = urlParams.get('subIds') || 'Abgabe Punktzahl';
        const question1Param = urlParams.get('question1') || 'Gib links deinen Code ein und füge rechts den Screenshot ein. Bewege die Maus über das Bild, um es zu vergrößern.';
        
        titleElement.textContent = subIdsParam;
        questionElement.innerHTML = question1Param;
        
        // --- Core Functions (Unchanged) ---
        window.addEventListener('paste', handlePaste);
        submitButton.addEventListener('click', handleSubmit);
        studentNameInput.addEventListener('input', checkFormState);

        function handlePaste(event) {
            const items = (event.clipboardData || window.clipboardData).items;
            let imageFile = null;
            for (const item of items) { if (item.type.indexOf('image') !== -1) { imageFile = item.getAsFile(); break; } }
            if (imageFile) {
                event.preventDefault();
                statusDiv.textContent = 'Bild erkannt!'; statusDiv.style.color = 'green';
                const reader = new FileReader();
                reader.onloadend = () => { 
                    imageDataUrl = reader.result; 
                    previewImage.src = imageDataUrl; 
                    previewImage.style.display = 'block';
                    pasteArea.classList.add('has-image');
                    checkFormState();
                    initializeZoom(imageDataUrl); 
                };
                reader.readAsDataURL(imageFile);
            }
        }
        
        function checkFormState() { /* ... unchanged ... */ submitButton.disabled = !(studentNameInput.value.trim() && imageDataUrl); }
        function handleSubmit() { /* ... unchanged ... */ if (!studentNameInput.value.trim() || !imageDataUrl) return; submitButton.disabled = true; statusDiv.textContent = 'Wird übermittelt...'; statusDiv.style.color = 'black'; const payload = { studentName: studentNameInput.value.trim(), imageData: imageDataUrl, assignmentId: assignmentIdParam, subIds: subIdsParam, question1: question1Param }; fetch(SCRIPT_URL, { method: 'POST', mode: 'cors', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(payload) }).then(res => res.json()).then(result => { if (result.status === 'success') { if (result.score && result.score.includes('/')) { statusDiv.style.color = 'green'; statusDiv.innerHTML = `Erfolgreich! Punktzahl: <strong>${result.score}</strong>`; } else { statusDiv.style.color = '#D83B01'; statusDiv.innerHTML = `Übermittelt, aber Punktzahl nicht erkannt. Bitte erneut versuchen.`; } resetForm(); } else { throw new Error(result.message); } }).catch(err => { statusDiv.textContent = `Fehler: ${err.message}`; statusDiv.style.color = 'red'; submitButton.disabled = false; }); }
        function resetForm() { /* ... unchanged ... */ setTimeout(() => { studentNameInput.value = ''; previewImage.src = ''; previewImage.style.display = 'none'; pasteArea.classList.remove('has-image'); imageDataUrl = null; submitButton.disabled = true; statusDiv.textContent = ''; destroyZoom(); }, 8000); }

        // --- REWRITTEN ZOOM FUNCTIONALITY ---

        let zoomMetrics = {}; // Object to hold calculated zoom values

        function initializeZoom(imageUrl) {
            if (eventListenersAttached) destroyZoom(); // Reset if a new image is pasted

            const originalImage = new Image();
            originalImage.onload = function() {
                // Calculate the true rendered dimensions and offsets of the image
                const containerW = previewImage.clientWidth;
                const containerH = previewImage.clientHeight;
                const imgW = this.width;
                const imgH = this.height;
                const containerRatio = containerW / containerH;
                const imgRatio = imgW / imgH;

                let renderedW, renderedH, offsetX, offsetY;

                if (imgRatio > containerRatio) { // Image is wider, letterboxed top/bottom
                    renderedW = containerW;
                    renderedH = containerW / imgRatio;
                    offsetX = 0;
                    offsetY = (containerH - renderedH) / 2;
                } else { // Image is taller, letterboxed left/right
                    renderedH = containerH;
                    renderedW = containerH * imgRatio;
                    offsetY = 0;
                    offsetX = (containerW - renderedW) / 2;
                }
                
                // Store all calculated metrics
                zoomMetrics = {
                    ratioX: imgW / renderedW,
                    ratioY: imgH / renderedH,
                    offsetX: offsetX,
                    offsetY: offsetY,
                    renderedW: renderedW,
                    renderedH: renderedH
                };

                zoomResult.style.backgroundImage = `url('${imageUrl}')`;
                zoomResult.style.backgroundSize = `${imgW}px ${imgH}px`;

                pasteArea.addEventListener('mousemove', moveLens);
                pasteArea.addEventListener('mouseenter', showZoom);
                pasteArea.addEventListener('mouseleave', hideZoom);
                eventListenersAttached = true;
            };
            originalImage.src = imageUrl;
        }

        const showZoom = () => {
            zoomResult.style.display = 'block';
            zoomLens.style.display = 'block';
        };

        const hideZoom = () => {
            zoomResult.style.display = 'none';
            zoomLens.style.display = 'none';
        };

        function moveLens(e) {
            e.preventDefault();
            const { ratioX, ratioY, offsetX, offsetY, renderedW, renderedH } = zoomMetrics;
            const rect = previewImage.getBoundingClientRect();
            
            // Cursor position relative to the previewImage element
            let x = e.clientX - rect.left;
            let y = e.clientY - rect.top;

            // If cursor is over the letterboxed area, hide zoom and exit
            if (x < offsetX || x > renderedW + offsetX || y < offsetY || y > renderedH + offsetY) {
                hideZoom();
                return;
            }
            // If it was hidden, show it again
            if(zoomLens.style.display === 'none') showZoom();
            
            // Cursor position relative to the *actual visible image*
            const trueX = x - offsetX;
            const trueY = y - offsetY;

            // Position the LENS element
            let lensX = x - (zoomLens.offsetWidth / 2);
            let lensY = y - (zoomLens.offsetHeight / 2);

            zoomLens.style.left = lensX + 'px';
            zoomLens.style.top = lensY + 'px';

            // Calculate background position for the RESULT pane using true coordinates
            let bgPosX = -(trueX * ratioX - zoomResult.clientWidth / 2);
            let bgPosY = -(trueY * ratioY - zoomResult.clientHeight / 2);
            
            zoomResult.style.backgroundPosition = `${bgPosX}px ${bgPosY}px`;
        }

        function destroyZoom() {
            if (!eventListenersAttached) return;
            pasteArea.removeEventListener('mousemove', moveLens);
            pasteArea.removeEventListener('mouseenter', showZoom);
            pasteArea.removeEventListener('mouseleave', hideZoom);
            hideZoom();
            eventListenersAttached = false;
            zoomMetrics = {};
        }
    </script>
</body>
</html>
